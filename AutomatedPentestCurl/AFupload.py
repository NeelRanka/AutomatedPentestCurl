import utility
import json

def AFCode(file_name, AttackID, payloadFile, out_filename):
	print("starting AFCode",file_name,out_filename)
	with open(payloadFile) as f:
		payloadDict = json.load(f)
	file = open(file_name)
	cmd=""
	status = None
	uniqueCode=AttackID.split('-')[0]
	for line in file:
		print(line)
		if "###" in line:
			if cmd !="":
				if "curl" in cmd :
					try:
						print("***trying")
						newCurl = cmd.format_map(payloadDict)
						utility.makeReq(newCurl,uniqueCode,out_filename)
						utility.makeAndAddJSON(newCurl,out_filename,"ACTUAL_FILE_CONTENTS")
						status = True
					except Exception as error:
						print("[-] some error occured in AFUpload :: ",error)
						return(False)

			cmd = ""
		
		else:
			cmd+=line.strip("\\\n")
	
	file.close()
	utility.removeTempFile("./tempCurls/curls_"+ uniqueCode +".sh")
	OKFlag = utility.changeStatus(AttackID,utility.completed)
	
	if not OKFlag:
		return("The process has been completed but status code might have an error")
	print("\n\n[+] Attack Completed and File saved "+out_filename)
	if status == None:
		print("No Delim Found (Maybe)")
		return(False)
	return(status)
