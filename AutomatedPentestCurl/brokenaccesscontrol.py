import string
import random
import json
import os
import utility


keywords =['phpssid', 'avid', 'uuid', 'TOKEN','JOTFORM_SESSION']
ids = []
ind = 0

"""curl="curl -i -s -k -X $'POST' \

    -H $'Host: easytowndeal.com' -H $'Content-Length: 396' -H $'Sec-Ch-Ua: \" Not A;Brand\";v=\"99\", \"Chromium\";v=\"96\"' -H $'X-Csrf-Token: fBFVgXc6Yx08JKXnEvdmmfcpyhy8D7JL3zlfBVy5' -H $'Sec-Ch-Ua-Mobile: ?0' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36' -H $'Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryzrpKTTelXrh0lFZz' -H $'Accept: application/json, text/javascript, */*; q=0.01' -H $'X-Requested-With: XMLHttpRequest' -H $'Sec-Ch-Ua-Platform: \"Linux\"' -H $'Origin: https://easytowndeal.com' -H $'Sec-Fetch-Site: same-origin' -H $'Sec-Fetch-Mode: cors' -H $'Sec-Fetch-Dest: empty' -H $'Referer: https://easytowndeal.com/' -H $'Accept-Encoding: gzip, deflate' -H $'Accept-Language: en-GB,en-US;q=0.9,en;q=0.8' \

    -b $'XSRF-TOKEN=eyJpdiI6ImUxT09VUnFrOTBVTVQ5aTVUemtsb0E9PSIsInZhbHVlIjoiaURQa29ySXluSFpFTHU0TXZpYmNYQkpyYWNaRVBtN1JTVUZ2cVwvXC84ZWZSXC84R3ZOQjU5WW1lbUxBZVZEZXBmUHM4QUNPTGV4N2hwdUQ2enk2cDU5eG5zZUJUZlIxMHZhNFRqdjllSTluV2oxUnNHbWZDM25lT2JraVRyakRjWDEiLCJtYWMiOiJhMmFhZjZmM2Y1NjVhOGY0NzAwMGVkZGJjNGFkZTk2YThhZDhlZjBkZTc1YWY2NDA0MGU1MjM3NTgzMzAxODRlIn0%3D; easytowndeal_session=eyJpdiI6IlJrWXowcXFxd214d0Z6VUdSSE1qTlE9PSIsInZhbHVlIjoibTBOUVNFV2ZjSFMxUGYyTXJBazFaaktpMGZ1cUs3NFkwSmc5ZVBwQzYrTkp3dHJ6S0lNanc4WVVob0JuZmJDT241U0gyUmY4UnFiSStUQ1wvRFY3ckFEZllkaWFkS1czdFlmWUNBWnhNTTFEZUZRbjcrNnFzd3pOXC93KzZrSUtJOCIsIm1hYyI6ImE5NWQ5NzAxZTJmZDA5NmMzZDI2YWMwYWUzYjFjNmQ0NGVjMzExMmQ3Yjk1NzdjNzM4ZjM1MmIzYTIxMGY3NjgifQ%3D%3D' \

    --data-binary $'------WebKitFormBoundaryzrpKTTelXrh0lFZz\x0d\x0aContent-Disposition: form-data; name=\"_token\"\x0d\x0a\x0d\x0afBFVgXc6Yx08JKXnEvdmmfcpyhy8D7JL3zlfBVy5\x0d\x0a------WebKitFormBoundaryzrpKTTelXrh0lFZz\x0d\x0aContent-Disposition: form-data; name=\"email\"\x0d\x0a\x0d\x0asupport@easytowndeal.com\x0d\x0a------WebKitFormBoundaryzrpKTTelXrh0lFZz\x0d\x0aContent-Disposition: form-data; name=\"password\"\x0d\x0a\x0d\x0aasdf@123\x0d\x0a------WebKitFormBoundaryzrpKTTelXrh0lFZz--\x0d\x0a' \

    $'https://easytowndeal.com/user_login'"

"""
def texttodict(curl):    
    for keyword in keywords:
        if keyword in curl:
            ind = curl.find(keyword)
            ind += len(keyword)+1
            i=0
            copy = ""
            j=0
            letter=0
            print("HAHAHAHA \n\n")
            for i in range(0,ind):
                copy+=curl[i]
            while curl[ind] not in ["'",'"',"&",";",","," "]:
                if j < 5:
                    letter = random.choice(string.ascii_letters)
                else:
                    letter = curl[ind]
                copy += letter
                ind+=1
                j+=1
            for i in range(ind,len(curl)):
                copy+=curl[i]
            print("HHEHE\n\n")	
            return copy,letter

def bacbruteforce(curl,bacpaylaod):    
    for keyword in keywords:
        print('\n\n',keyword,'\n\n')
        print(curl)
        print(bacpaylaod)
        if(curl.find(keyword)>=0):
            index_init=curl.find(keyword)
            print(keyword)
            index=curl.find(keyword)
            for i in range(len(keyword)+index+1 , len(curl)):
                if curl[i]=="'" or curl[i]=='&' or curl[i]=='' or curl[i]=='"' or curl[i]==';':
                    break
                index+=1
            print()
            final_curl= curl[:len(keyword)+index_init+1] + bacpaylaod + curl[index:]
            return final_curl,bacpaylaod
               

def extractUrl(curl):
    url = ""
    ind = curl.find('http')
    i=ind
    while curl[i] not in ["'",'"']:
        url += curl[i]
        i+=1
    return url

def BACcurlextract(file_name ,out_filename, BACAttackID, BACpayloads):	
	print("starting curl extract",file_name)
	file = open(file_name)
	cmd=""
	uniqueCode=BACAttackID.split('-')[0]
	for line in file:
		# print("#"*100)
		if "###" in line:
			if cmd !="":
				if "curl" in cmd :
					try:
						print('errrrrrrrrrrrrr1\n\n')
						bac(cmd,BACAttackID,out_filename,BACpayloads)
						print('\n\ncompleted command c\n\n', cmd)
						print("\nDone")
							
					except Exception as e:
						print("\n[*] Error occured :: ",e,"\n=>",cmd,"\n\n")		
			cmd = ""
		else:
			# print("line : ",line.strip("\\\n"))
			cmd+=line.strip("\\\n")

	print("Completed file read")
	file.close()
	print('changing status code')
	utility.removeTempFile("./tempCurls/curls_"+ uniqueCode +".sh")
	OKFlag = utility.changeStatus(BACAttackID,utility.completed)
	if not OKFlag:
		print(' \n\n notchanged status')
		return("The process has been completed but status code might have an error")
	print("\n\n[+] Attack Completed and File saved "+out_filename)


def bac(curl,BACAttackID,out_filename,BACpayloads):
	print('\n\n =====>> bacpayload **',BACpayloads)
	uniqueCode=BACAttackID.split('-')[0]
	# print(BACpayloads)
	if BACpayloads == None:
		# print('errrrrrrrrrrrrr2\n\n')
		req,payload =texttodict(curl)
		# print("===>>",req,"\n\n")
		utility.makeReq(req,uniqueCode,out_filename)
		utility.makeAndAddJSON(req,out_filename,payload)
		# print('reurning from bac')

	else:
		# print('errrrrrrrrrrrrr3\n\n')
		BACpayloads=BACpayloads.split('###')
		for bacpaylaod in BACpayloads:
			# print('errrrrrrrrrrrrr4\n\n')
			# print(bacpaylaod)
			req,payload = bacbruteforce(curl,bacpaylaod)
			# print('errrrrrrrrrrrrr5\n\n')
			# print("===>>",req,"\n\n")
			utility.makeReq(req,uniqueCode,out_filename)
			utility.makeAndAddJSON(req,out_filename,bacpaylaod)
		# print('returning from bac')